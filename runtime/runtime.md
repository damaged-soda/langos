# 自然语言运行时与确认流程

## 快速指引：按需读取
- 始终加载（AI 初始化）：`langos/runtime/guidelines.md`、本文件、`langos/runtime/protocols/index.yaml`。
- 仅在改“OS”/规范/协议时加载：`runtime/conventions.md`，其余背景文档见文档仓 `../langos-docs/repos/langos/`。
- 业务任务时按需加载：业务文档库的仓库索引（如 repos/INDEX.md）→ 目标仓库文档（overview/architecture/ai-notes 等，若存在）→ 相关需求/项目文档（示例 specs、projects）。缺什么再读什么。

定位：执行层流程说明；对话行为底线见 `langos/runtime/guidelines.md`。  
本文件描述“接口与执行层”如何把自然语言请求路由到协议，并在需求→方案→编码→评审四个环节保持可控、可审计、可复用。

## 1. 角色与输入
- 入口：人类的自然语言请求（中文），包含意图或任务描述。
- 路由器：`langos/runtime/protocols/index.yaml`，负责从意图/例句匹配候选协议。
- 执行单元：`protocols/*.yaml` 中的步骤（ASK_USER / ANALYZE_* / PLAN_* / DRAFT_* / CONFIRM_* 等）。
- 输出：协议步骤的中间结果与确认记录（需求草稿、方案要点、代码变更说明、评审结论）。

## 2. 基本流程
1) 解析与匹配：根据请求在 `index.yaml` 检索 1–3 个候选协议，向用户展示并询问是否采用；无匹配则说明按普通对话继续。  
2) 确认后执行：用户选择某协议后，按步骤顺序执行，不跳过 ASK/CONFIRM 类节点。  
3) 执行中遵守 `guidelines.md`：缺信息先问、不编造，必要假设需标注并复述确认。  
4) 产出与收尾：每个阶段产出草稿/片段并征求确认，收尾时总结达成与未决事项。  
5) 如修改协议/路由/规范（内核模式），先在文档仓参考 `governance.md` 等背景说明，写 spec → 草拟协议 → 按确认的方案落盘并更新 index（必要时可手动对话模拟关键路径）。

## 3. 默认确认闸门（当前覆盖范围）
- **需求确认**：需求梳理输出的结构化 spec 草稿需人工确认后，才进入方案。  
- **方案确认**：技术方案（模块/边界/数据/风险）需确认后，才进入编码。  
- **代码写入确认**：生成或修改代码/测试前，必须先复述预期变更与影响，获得确认后再写入/执行。  
- **评审结论确认**：评审列出问题/风险/结论后，需确认结论与后续动作。

## 4. 审计与可追溯
- 记录粒度：输入要点、生成的草稿片段、用户确认/拒绝的决策、重要假设。  
- 目标：能回溯“在什么信息与假设下做了什么决定”。  
- 建议记录位置：与任务相关的文档草稿或评审输出内嵌要点与确认状态；无需额外系统时，可在对话或文档内标注“待确认/已确认”。

## 5. 复用资产
- 协议与索引：`langos/runtime/protocols/*.yaml` 与 `index.yaml`。  
- 通用行为规范：`langos/runtime/guidelines.md`。  
- 目录/命名/写作规范：`runtime/conventions.md`。  
- 可复用模板/检查单：可放在 `langos/runtime/` 下的协议或附录中，按需扩展。

## 6. 退化路径
- 若无合适协议或用户选择不用协议，按普通对话处理，但仍遵守 `guidelines.md` 的行为底线。

## 7. 更新与扩展
- 新增或调整流程时，按自举流程完成需求与方案后直接修改协议文件，并同步 `index.yaml`。  
- 需要新增确认点或移除确认点时，应在相关协议与本文件中明示，避免隐性跳步。
